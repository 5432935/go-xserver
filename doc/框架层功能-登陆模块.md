## 框架层负责的工作

- 提供缺省账号验证
- 提供账号正常登陆
  - 提供账号正常上下线，不会回档等错误
  - 提供同账号多端同时登陆，不会异常
  - 提供账号服务器资源分配、比如分配 Gateway 资源
  - 提供自定义验证接口，方便定制化`账号验证`逻辑

## 时序图

```mermaid
sequenceDiagram
participant Client
participant LoginServer
participant Redis
participant Gateway
Client->>LoginServer: 1. 账号登陆
Note right of LoginServer: 1. 账号相关验证（略）
Note right of LoginServer: 2. 本地缓存中选取一个Gateway
LoginServer->>Redis: 2.1 SETX { uid, gatewayid } 键值对
alt 如果设置失败
  LoginServer-->>Redis: GET { uid, gatewayid } 键值对
  Redis-->>LoginServer: 返回 gatewayid
end
LoginServer->>LoginServer: 2.2 检查对应的 gateway 是否失效
alt gateway 已失效
  LoginServer-->>Redis: DELX { uid, gatewayid } 键值对
  LoginServer-->>Client: 本次登陆流程失败
end
LoginServer->>Redis: 3. SET { uid, token } 键值对
LoginServer->>Client: 4. 返回OK, IP/Port/Token
Note right of Gateway: 5. 账号登陆 Gateway 等等（略）
Gateway->>Redis: 5.1 EXPIRE { uid, gatewayid } 键值对（设置过期1年）
Note right of Gateway: 6. 账号连接断开事件触发
Gateway->>Redis: 6. EXPIRE { uid, gatewayid } 键值对（设置过期10分钟）
```

补充说明：
  - `SETX` ：不管 SET NX 有没有设置成功，都重置过期时间为 1 年
  - `DELX` ：条件删除， if value = "xxx" then del key
  - 1 、 4 逻辑层自定义处理
  - 2 、 3 框架层处理
  - 5 、 6 内容 Gateway 相关，其他文档详细说明
